stages:
  - lint
  - build
  - test
  - report
  - deploy
  - notify

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHA
  DOCKER_DRIVER: overlay2

# ---------- LINT ----------
lint:
  stage: lint
  image: python:3.13
  script:
    - pip install --upgrade pip
    - pip install flake8
    - flake8 .
  only: [main, master]

# ---------- BUILD ----------
build:
  stage: build
  image: docker:28.0.0
  services: [docker:dind]
  before_script:
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:latest
  only: [main, master]

# ---------- SMOKE ----------
smoke-tests:
  stage: test
  image: docker:28.0.0
  services: [docker:dind]
  needs: [build]
  script:
    - mkdir -p allure-results-smoke
    - export DECODED_ADMIN_USERNAME=$(echo $ADMIN_USERNAME | base64 -d)
    - >
      docker run --rm --ipc=host --init
      -v $(pwd)/allure-results-smoke:/app/allure-results
      -e BASE_URL=$BASE_URL
      -e ADMIN_USERNAME=$DECODED_ADMIN_USERNAME
      -e ADMIN_PASSWORD=$ADMIN_PASSWORD
      $IMAGE_NAME:$IMAGE_TAG
      pytest -m smoke -n auto --alluredir=/app/allure-results
  artifacts:
    paths: [allure-results-smoke]
    when: always
    expire_in: 7 days

# ---------- PARALLEL (api/ui) ----------
run-tests-parallel:
  stage: test
  image: docker:28.0.0
  services: [docker:dind]
  needs: [smoke-tests]
  parallel:
    matrix:
      - TEST_GROUP: api
      - TEST_GROUP: ui
  script:
    - mkdir -p allure-results-${TEST_GROUP}
    - export DECODED_ADMIN_USERNAME=$(echo $ADMIN_USERNAME | base64 -d)
    - >
      docker run --rm --ipc=host --init
      -v $(pwd)/allure-results-${TEST_GROUP}:/app/allure-results
      -e BASE_URL=$BASE_URL
      -e ADMIN_USERNAME=$DECODED_ADMIN_USERNAME
      -e ADMIN_PASSWORD=$ADMIN_PASSWORD
      $IMAGE_NAME:$IMAGE_TAG
      pytest -m $TEST_GROUP -n auto --alluredir=/app/allure-results
  artifacts:
    paths:
      - allure-results-${TEST_GROUP}
    when: always
    expire_in: 7 days

# ---------- PUBLISH REPORT ----------
publish-report:
  stage: report
  image: openjdk:17-jdk-slim
  # –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Å–µ–≥–¥–∞ –∏ —Å–æ–±–∏—Ä–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
  needs:
    - job: smoke-tests
      artifacts: true
      optional: true
    - job: run-tests-parallel
      artifacts: true
      optional: true
  when: always
  script:
    - apt-get update && apt-get install -y wget unzip
    - wget -q https://github.com/allure-framework/allure2/releases/download/2.34.1/allure-2.34.1.zip
    - unzip -q allure-2.34.1.zip
    - mkdir -p merged-results
    - cp -r allure-results-smoke/* merged-results/  || true
    - cp -r allure-results-api/*   merged-results/  || true
    - cp -r allure-results-ui/*    merged-results/  || true
    - ./allure-2.34.1/bin/allure generate merged-results --clean -o allure-report || true
  artifacts:
    paths: [allure-report]
    expire_in: 7 days

# ---------- DEPLOY PAGES ----------
pages:
  stage: deploy
  image: alpine:latest
  needs:
    - job: publish-report
      optional: true
  when: always
  script:
    - mv allure-report public || mkdir -p public
  artifacts:
    paths: [public]
  only: [main, master]

# ---------- TELEGRAM ----------
notify-telegram:
  stage: notify
  image: curlimages/curl:latest
  needs:
    - job: pages
      optional: true
  when: always
  script:
    - |
      # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      STATUS="${CI_JOB_STATUS}"
      REPORT_URL="https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}/"
      
      # 2. –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º commit message. –≠—Ç–æ—Ç sed-—Å–∫—Ä–∏–ø—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç
      # –≤—Å–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã, —Ç—Ä–µ–±—É–µ–º—ã–µ MarkdownV2.
      COMMIT_MSG=$(printf "%s" "${CI_COMMIT_MESSAGE}" | sed -e 's/\([_*\[\]()~`>#+-=|{}.!]\)/\\&/g')
      
      # 3. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –û–î–ù–û–ô –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –∏—Å–ø–æ–ª—å–∑—É—è %0A –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫.
      # –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ curl.
      MESSAGE="*‚úÖ Pipeline Status:* ${STATUS}%0A%0A"
      MESSAGE="${MESSAGE}*üì¶ Repo:* [${CI_PROJECT_NAME}](${CI_PROJECT_URL})%0A"
      MESSAGE="${MESSAGE}*üåø Branch:* \`${CI_COMMIT_REF_NAME}\`%0A"
      MESSAGE="${MESSAGE}*üìù Commit:* ${COMMIT_MSG}%0A"
      MESSAGE="${MESSAGE}*üë§ Triggered by:* ${GITLAB_USER_NAME}%0A%0A"
      MESSAGE="${MESSAGE}[üìä Allure Report](${REPORT_URL})"
      
      # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è --data-urlencode –¥–ª—è –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.
      # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –±—É–¥—É—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã.
      curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
        -d "parse_mode=MarkdownV2" \
        --data-urlencode "text=${MESSAGE}"